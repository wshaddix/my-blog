<!DOCTYPE html>
<html lang="en">
<head>

  <meta charset="utf-8" />

  
  <title>Docker Swarm on Azure</title>

  
  





  
  <meta name="author" content="Wes Shaddix" />
  <meta name="description" content="I&amp;rsquo;m learning docker swarm mode and need a realistic simulation of setting up a multi-node cluster. Azure is an ideal platform to test things out. My goal is to create a docker swarm cluster within a single region. Creating a multi-region swarm cluster requires creating virutal networks in different regions and connecting those vnets through a vpn gateway which is not something I&amp;rsquo;m ready to tackle just yet.
My Setup I&amp;rsquo;m running a windows 10 workstation with docker for windows." />

  
  
    <meta name="twitter:card" content="summary" />
    <meta name="twitter:site" content="@wshaddix" />
    <meta name="twitter:title" content="Docker Swarm on Azure" />
    <meta name="twitter:description" content="I&amp;rsquo;m learning docker swarm mode and need a realistic simulation of setting up a multi-node cluster. Azure is an ideal platform to test things out. My goal is to create a docker swarm cluster within a single region. Creating a multi-region swarm cluster requires creating virutal networks in different regions and connecting those vnets through a vpn gateway which is not something I&amp;rsquo;m ready to tackle just yet.
My Setup I&amp;rsquo;m running a windows 10 workstation with docker for windows." />
    <meta name="twitter:image" content="http://www.wesshaddix.com/img/avatar.jpg" />
  




<meta name="generator" content="Hugo 0.31.1" />


<link rel="canonical" href="http://www.wesshaddix.com/post/docker-swarm/" />
<link rel="alternative" href="http://www.wesshaddix.com/index.xml" title="Wes Shaddix" type="application/atom+xml" />


<meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<meta name="format-detection" content="telephone=no,email=no,adress=no" />
<meta http-equiv="Cache-Control" content="no-transform" />


<meta name="robots" content="index,follow" />
<meta name="referrer" content="origin-when-cross-origin" />







<meta name="apple-mobile-web-app-capable" content="yes" />
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
<meta name="apple-mobile-web-app-title" content="Wes Shaddix" />
<meta name="msapplication-tooltip" content="Wes Shaddix" />
<meta name='msapplication-navbutton-color' content="#5fbf5e" />
<meta name="msapplication-TileColor" content="#5fbf5e" />
<meta name="msapplication-TileImage" content="/img/tile-image-windows.png" />
<link rel="icon" href="http://www.wesshaddix.com/img/favicon.ico" />
<link rel="icon" type="image/png" sizes="16x16" href="http://www.wesshaddix.com/img/favicon-16x16.png" />
<link rel="icon" type="image/png" sizes="32x32" href="http://www.wesshaddix.com/img/favicon-32x32.png" />
<link rel="icon" sizes="192x192" href="http://www.wesshaddix.com/img/touch-icon-android.png" />
<link rel="apple-touch-icon" href="http://www.wesshaddix.com/img/touch-icon-apple.png" />
<link rel="mask-icon" href="http://www.wesshaddix.com/img/safari-pinned-tab.svg" color="#5fbf5e" />



<link rel="stylesheet" href="//cdn.bootcss.com/video.js/6.2.8/alt/video-js-cdn.min.css" />

<link rel="stylesheet" href="http://www.wesshaddix.com/css/bundle.css" />


  
  <!--[if lt IE 9]>
    <script src="//cdn.bootcss.com/html5shiv/3.7.3/html5shiv.min.js"></script>
    <script src="//cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
    <script src="//cdn.bootcss.com/video.js/6.2.8/ie8/videojs-ie8.min.js"></script>
  <![endif]-->

<!--[if lte IE 11]>
    <script src="//cdn.bootcss.com/classlist/1.1.20170427/classList.min.js"></script>
  <![endif]-->


<script src="//cdn.bootcss.com/object-fit-images/3.2.3/ofi.min.js"></script>


<script src="//cdn.bootcss.com/smooth-scroll/12.1.4/js/smooth-scroll.polyfills.min.js"></script>


</head>
  <body>
    
    <div class="suspension">
      <a title="Go to top" class="to-top is-hide"><span class="icon icon-up"></span></a>
      
        
        <a title="Go to comments" class="to-comment" href="#disqus_thread"><span class="icon icon-comment"></span></a>
        
      
    </div>
    
    
  <header class="site-header">
  <img class="avatar" src="http://www.wesshaddix.com/img/avatar.jpg" alt="Avatar">
  
  <h2 class="title">Wes Shaddix</h2>
  
  <p class="subtitle"></p>
  <button class="menu-toggle" type="button">
    <span class="icon icon-menu"></span>
  </button>
  <nav class="site-menu collapsed">
    <h2 class="offscreen">Main Menu</h2>
    <ul class="menu-list">
      
      
      
      
        <li class="menu-item
            
            
            
              is-active
            ">
            <a href="http://www.wesshaddix.com/">My Blog</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="https://github.com/wshaddix">My Projects</a>
          </li>
      
        <li class="menu-item
            
            
            ">
            <a href="http://www.wesshaddix.com/tags/">Tags</a>
          </li>
      
    </ul>
  </nav>
  <nav class="social-menu collapsed">
    <h2 class="offscreen">Social Networks</h2>
    <ul class="social-list">

      
      <li class="social-item">
        <a href="mailto:wes.shaddix@outlook.com" title="Email"><span class="icon icon-email"></span></a>
      </li>

      
      <li class="social-item">
        <a href="//github.com/wshaddix" title="GitHub"><span class="icon icon-github"></span></a>
      </li>

      <li class="social-item">
        <a href="//twitter.com/wshaddix" title="Twitter"><span class="icon icon-twitter"></span></a>
      </li>

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      

      <li class="social-item">
        <a href="http://www.wesshaddix.com/index.xml"><span class="icon icon-rss" title="RSS"></span></a>
      </li>

    </ul>
  </nav>
</header>

  <section class="main post-detail">
    <header class="post-header">
      <h1 class="post-title">Docker Swarm on Azure</h1>
      <p class="post-meta">@Wes Shaddix · Dec 6, 2017 · 6 min read</p>
    </header>
    <article class="post-content">

<p>I&rsquo;m learning docker swarm mode and need a realistic simulation of setting up a multi-node cluster. Azure is an ideal platform to test things out. My goal is to create a docker swarm cluster within a <strong>single</strong> region. Creating a multi-region swarm cluster requires creating virutal networks in different regions and connecting those vnets through a vpn gateway which is not something I&rsquo;m ready to tackle just yet.</p>

<h3 id="my-setup">My Setup</h3>

<p>I&rsquo;m running a windows 10 workstation with docker for windows.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">λ ver
Microsoft Windows <span style="color:#66d9ef">[Version 10.0.16299.98]</span>

λ docker --version
Docker version 17.09.0-ce, build afdb6d4</code></pre></div>
<h3 id="getting-the-azure-cli">Getting the Azure CLI</h3>

<p>I know I want to use the Azure CLI v2 in order to be able to manage my azure resources from the command line but I don&rsquo;t want to have to install/configure it along with whatever programming languages it requires. Instead I just want to use it from a docker image (I already know this exists). In order to do that, I need to download and run it in a container so from my powershell terminal I run</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">docker run --rm -v ${HOME}<span style="color:#960050;background-color:#1e0010">:</span>/root -it azuresdk/azure-cli-python<span style="color:#960050;background-color:#1e0010">:</span>latest</code></pre></div>
<p>This will run a container that has the azure cli ready to go. The <code>--rm</code> argument means that the container will be removed once I exit from it. The <code>-v ${HOME}:/root</code> argument maps my home directory on my Windows 10 host to the /root folder inside the docker container. This means anything written to the /root folder in the container will be saved on my host machine and be available the next time I run the container. Finally the <code>-it</code> argument will put me at the terminal of the container where I can interact with it.</p>

<h3 id="logging-into-my-azure-account">Logging into my Azure account</h3>

<p>Now that I have access to the Azure CLI, I need to authenticate to my Azure account. To do that I run</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">az login</code></pre></div>
<p>When you run this command it will give you a url along with a code. Simply open the url in your web browser and paste in the code and it will authorize your Azure CLI to access your Azure account.</p>

<h3 id="creating-a-resource-group">Creating a resource group</h3>

<p>In order to be able to easily organize and later remove any and all resources that are related to my docker swarm I want to put everything in resource groups. Resource groups are bound to geographic locations so I will create one group that is close to my location. The location could be <a href="https://azure.microsoft.com/en-us/regions/">anywhere that Azure supports</a>.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">az group create -l eastus -n docker-us-east</code></pre></div>
<h3 id="creating-the-network-security-groups">Creating the Network Security Groups</h3>

<p>In order to allow/deny traffic to and from our virtual machines we will create two network security groups. One to allow only ssh traffic in from the internet and one to allow docker traffic that will be used by the swarm manager and worker nodes.</p>

<h4 id="allowing-ssh-traffic">Allowing ssh traffic</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">az network nsg create -g docker-us-east -n nsg-public-internet-traffic --tags docker_managers

az network nsg rule create -g docker-us-east --nsg-name public-internet-traffic -n allow-ssh --destination-port-ranges 22 --access Allow --description <span style="color:#e6db74">&#34;Allow inbound ssh traffic&#34;</span> --priority 100</code></pre></div>
<h4 id="allowing-docker-traffic">Allowing docker traffic</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">az network nsg create -g docker-us-east -n nsg-docker-traffic --tags docker_workers

az network nsg rule create -g docker-us-east --nsg-name docker-traffic -n allow-docker-swarm --destination-port-ranges 2377 7946 4789 --access Allow --description <span style="color:#e6db74">&#34;Allow docker swarm traffic&#34;</span> --priority 100</code></pre></div>
<h3 id="creating-the-virtual-network">Creating the virtual network</h3>

<p>Next up, we need a virtual network that the docker hosts can connect to in order to communicate with each other. We&rsquo;ll create two subnets, one &ldquo;front-end&rdquo; subnet that allows ssh traffic from the internet and one &ldquo;back-end&rdquo; subnet that allows docker traffic between host virtual machines that is not exposed to the internet. This will allow us to reduce the attack surface of the swarm cluster to just the one ssh port on the manager node.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">az network vnet create -g docker-us-east -n docker-swarm-vnet</code></pre></div>
<h3 id="creating-the-subnets">Creating the subnets</h3>

<p>The first subnet that we&rsquo;ll create will be used to allow public ssh traffic from the internet. This will be used by the manager node and will be where all docker swarm commands are ran from. This subnet will also be protected by the <code>public-internet-traffic</code> network security group that we just created.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">az network vnet subnet create -g docker-us-east --vnet-name docker-swarm-vnet -n ssh-subnet --address-prefix 10.0.0.0/24 --network-security-group public-internet-traffic</code></pre></div>
<p>The second subnet that we&rsquo;ll create will be used to allow docker traffic between the docker host virtual machines and will not be accessible to the public internet. This subnet will also be protected by the <code>docker-traffic</code> network security group that we just created.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">az network vnet subnet create -g docker-us-east --vnet-name docker-swarm-vnet -n docker-subnet --address-prefix 10.0.1.0/24 --network-security-group docker-traffic</code></pre></div>
<h3 id="create-a-public-static-ip-address">Create a public static ip address</h3>

<p>In order for us to be able to ssh to the docker swarm manager over the internet we need a public ip address that we can assign to the host virtal machine.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">az network public-ip create -g docker-us-east -n docker-swarm-mgr-ip --allocation-method Static</code></pre></div>
<p>The output of this command will tell you what ip address was allocated. In my example it was <code>52.224.220.107</code></p>

<h3 id="create-a-nic-for-the-public-connection-of-the-docker-swarm-manager">Create a NIC for the public connection of the docker swarm manager</h3>

<p>The virtual machine that will be the docker swarm manager will need to have two network cards associated with it. The first NIC will be for the public facing subnet that allows ssh traffic and the second NIC will be for the private subnet that allows docker traffic.</p>

<h4 id="public-nic">Public NIC</h4>

<p>We bind the public ip address that we created to the public NIC.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">az network nic create -g docker-us-east -n docker-swarm-mgr-public-nic --vnet-name docker-swarm-vnet --subnet ssh-subnet --public-ip-address docker-swarm-mgr-ip</code></pre></div>
<h4 id="private-nic">Private NIC</h4>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">az network nic create -g docker-us-east -n docker-swarm-mgr-private-nic --vnet-name docker-swarm-vnet --subnet docker-subnet</code></pre></div>
<h3 id="create-the-docker-swarm-manager-vm">Create the Docker Swarm Manager VM</h3>

<p>We&rsquo;ll create an Ubuntu 17.04 VM and attach the public and private NICs that we just created. This will join it to both the ssh and docker subnets that we created.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">az vm create -g docker-us-east -n docker-swarm-mgr --generate-ssh-keys --nics docker-swarm-mgr-public-nic docker-swarm-mgr-private-nic --image Canonical<span style="color:#960050;background-color:#1e0010">:</span>UbuntuServer<span style="color:#960050;background-color:#1e0010">:</span>17.04<span style="color:#960050;background-color:#1e0010">:</span>17.04.201711210 --size Standard_B2S --authentication-type ssh --admin-username wshaddix --os-disk-name docker-swarm-mgr-os-disk</code></pre></div>
<h3 id="verify-ssh-access-from-your-workstation">Verify ssh access from your workstation</h3>

<p>Once the swarm manager vm is provisioned, ensure that things are setup correctly by starting an ssh connection with the vm.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">ssh wshaddix@52.224.220.107</code></pre></div>
<h3 id="create-the-first-docker-swarm-worker-vm">Create the first Docker Swarm Worker VM</h3>

<p>The swarm worker node doesn&rsquo;t need custom NICs because we can just specify that it should be connected to the docker-swarm-vnet when we create it.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">az vm create -g docker-us-east -n docker-worker-1 --generate-ssh-keys --vnet-name docker-swarm-vnet --subnet docker-subnet --image Canonical<span style="color:#960050;background-color:#1e0010">:</span>UbuntuServer<span style="color:#960050;background-color:#1e0010">:</span>17.04<span style="color:#960050;background-color:#1e0010">:</span>17.04.201711210 --size Standard_B2S --authentication-type ssh --admin-username wshaddix --public-ip-address <span style="color:#e6db74">&#34;&#34;</span> --nsg <span style="color:#e6db74">&#34;&#34;</span> --os-disk-name docker-swarm-worker1-os-disk</code></pre></div>
<h3 id="cleaning-up">Cleaning Up</h3>

<p>After you are done and ready to deprovision all of the resources that we&rsquo;ve created so that you are not billed for them, you can simply delete the resource group.</p>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-powershell" data-lang="powershell">az group delete -n docker-us-east</code></pre></div></article>
    <footer class="post-footer">
      
      <ul class="post-tags">
        
          <li><a href="http://www.wesshaddix.com/tags/docker"><span class="tag">Docker</span></a></li>
        
          <li><a href="http://www.wesshaddix.com/tags/docker-swarm"><span class="tag">Docker-Swarm</span></a></li>
        
      </ul>
      
      <p class="post-copyright">
        © This post is licensed under a Creative Commons Attribution-NonCommercial 4.0 International License. Please give a reference to this source if you would like to quote or reproduce.
      </p>
    </footer>
    
      <div id="disqus_thread"></div>
<script>
    var disqus_config = function () {
    
    
    
    };
    (function() {
        if (["localhost", "127.0.0.1"].indexOf(window.location.hostname) != -1) {
            document.getElementById('disqus_thread').innerHTML = 'Disqus comments not available by default when the website is previewed locally.';
            return;
        }
        var d = document, s = d.createElement('script'); s.async = true;
        s.src = '//' + "wesshaddix" + '.disqus.com/embed.js';
        s.setAttribute('data-timestamp', +new Date());
        (d.head || d.body).appendChild(s);
    })();
</script>
<noscript>Please enable JavaScript to view the <a href="https://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="https://disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>
      
    
  </section>
  <footer class="site-footer">
  <p>© 2017 Wes Shaddix</p>
  <p>Powered by <a href="https://gohugo.io/" target="_blank">Hugo</a> with theme <a href="https://github.com/laozhu/hugo-nuo" target="_blank">Nuo</a>.</p>
  
</footer>



<script async src="//cdn.bootcss.com/video.js/6.2.8/alt/video.novtt.min.js"></script>
<script async src="//cdn.bootcss.com/mathjax/2.7.2/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>
<script type="text/x-mathjax-config">
  MathJax.Hub.Config({
    tex2jax: {
      inlineMath: [['$','$'], ['\\(','\\)']],
      displayMath: [['$$','$$'], ['\[','\]']],
      processEscapes: true,
      processEnvironments: true,
      skipTags: ['script', 'noscript', 'style', 'textarea', 'pre'],
      TeX: { equationNumbers: { autoNumber: "AMS" },
      extensions: ["AMSmath.js", "AMSsymbols.js"] }
    }
  });
</script>
<script type="text/x-mathjax-config">
  // Fix <code> tags after MathJax finishes running. This is a
  // hack to overcome a shortcoming of Markdown. Discussion at
  // https://github.com/mojombo/jekyll/issues/199
  MathJax.Hub.Queue(() => {
    MathJax.Hub.getAllJax().map(v => v.SourceElement().parentNode.className += ' has-jax');
  });
</script>

<script src="http://www.wesshaddix.com/js/bundle.js"></script>


<script>
window.ga=window.ga||function(){(ga.q=ga.q||[]).push(arguments)};ga.l=+new Date;
ga('create', 'UA-XXXXXXXX-X', 'auto');
ga('send', 'pageview');
</script>
<script async src='//www.google-analytics.com/analytics.js'></script>





  </body>
</html>
